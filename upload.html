<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Glowzza - Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #f0f0f0, #d9fdd3);
      text-align: center;
      margin: 0;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 32px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .upload-section {
      margin: 20px auto;
      padding: 20px;
      border: 2px dashed #2196F3;
      border-radius: 12px;
      width: 400px;
      background-color: #fff;
    }

    .upload-section.dragover {
      background-color: #e3f2fd;
      border-color: #1976D2;
    }

    input[type="file"] {
      margin: 10px 0;
    }

    .boton-subir {
      width: 200px;
      height: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      margin-top: 10px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, background-color 0.2s;
    }
    .boton-subir:hover {
      background-color: #45a049;
      transform: scale(1.05);
    }

    .boton-volver {
      width: 280px;
      height: 60px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 12px;
      background-color: #777;
      color: white;
      border: none;
      margin-top: 30px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, background-color 0.2s;
    }
    .boton-volver:hover {
      background-color: #555;
      transform: scale(1.05);
    }

    .resumen {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border: 1px solid #4CAF50;
      border-radius: 8px;
      width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Upload de Datos</h1>

  <div class="upload-section" id="dropZone">
    <h2>Arrastr√° tu Full Download aqu√≠</h2>
    <p>O seleccion√° manualmente:</p>
    <input type="file" id="fullFile" accept=".txt">
    <button class="boton-subir" onclick="subirFull()">Subir</button>
  </div>

  <div id="resumen" class="resumen" style="display:none;"></div>

  <button onclick="location.href='menu.html'" class="boton-volver">Volver al Men√∫ Principal</button>

  <script type="module">
    import { getFirestore, setDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDrfX2Fszw9-M1DwzX_Sk63et9tw4ddOU",
      authDomain: "glowzzainventario.firebaseapp.com",
      projectId: "glowzzainventario",
      storageBucket: "glowzzainventario.appspot.com",
      messagingSenderId: "159721581844",
      appId: "1:159721581844:web:f62cdb303258dc847b6601",
      measurementId: "G-0FR3Q6P3L2"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function procesarFullArchivo(file) {
      const text = await file.text();
      const lineas = text.split("\n").map(l => l.trim());

      let sector = null;
      let contadores = { clientes:0, ventasCerradas:0, balance:0, productos:0 };

      for (const linea of lineas) {
        if (linea.startsWith("===")) {
          if (linea.includes("CLIENTES")) sector = "clientes";
          else if (linea.includes("VENTAS CERRADAS")) sector = "ventasCerradas";
          else if (linea.includes("BALANCE")) sector = "balance";
          else if (linea.includes("STOCK")) sector = "productos";
          else sector = null;
          continue;
        }

        if (!linea || !sector) continue;

        if (sector === "clientes") {
          const [nombre, telefono, fecha] = linea.split("|").map(s => s.trim());
          const id = "cliente_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);
          await setDoc(doc(db, "clientes", id), { nombre, telefono, fecha });
          contadores.clientes++;
        }

        if (sector === "ventasCerradas") {
          const [nombre, total, fechaCierre] = linea.split("|").map(s => s.trim());
          const id = "venta_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);
          await setDoc(doc(db, "ventasCerradas", id), { nombre, total: Number(total), fechaCierre });
          contadores.ventasCerradas++;
        }

        if (sector === "balance") {
          const [concepto, valor] = linea.split("|").map(s => s.trim());
          const id = "balance_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);
          await setDoc(doc(db, "balance", id), { concepto, valor: Number(valor) });
          contadores.balance++;
        }

        if (sector === "productos") {
          const partes = linea.split("|").map(s => s.trim());
          if (partes.length >= 5) {
            const [orden, nombre, color, stock, precio] = partes;
            const id = "producto_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);
            await setDoc(doc(db, "productos", id), { orden, nombre, color, stock: Number(stock), precio: Number(precio) });
            contadores.productos++;
          }
        }
      }

      // Mostrar resumen
      const resumenDiv = document.getElementById("resumen");
      resumenDiv.style.display = "block";
      resumenDiv.innerHTML = `
        <h3>Resumen de carga:</h3>
        <p>Clientes cargados: ${contadores.clientes}</p>
        <p>Ventas cerradas cargadas: ${contadores.ventasCerradas}</p>
        <p>Balance cargado: ${contadores.balance}</p>
        <p>Productos cargados: ${contadores.productos}</p>
      `;
    }

    // üîπ Subida con bot√≥n
    window.subirFull = () => {
      const fileInput = document.getElementById("fullFile");
      if (!fileInput.files.length) return alert("Selecciona un archivo primero");
      procesarFullArchivo(fileInput.files[0]);
    };

    // üîπ Arrastrar y soltar
    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && file.type === "text/plain") {
        procesarFullArchivo(file);
      } else {
        alert("Solo se aceptan archivos .txt");
      }
    });
  </script>
</body>
</html>