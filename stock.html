<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Stock</title>
</head>
<body>
  <h2>Control de Stock</h2>
  <button onclick="document.getElementById('archivoExcel').click()">Subir Excel</button>
  <button onclick="location.href='menu.html'">Volver al MenÃº Principal</button>

  <input type="file" id="archivoExcel" style="display:none" accept=".csv">

  <h3>Listado General</h3>
  <ul id="listaStock"></ul>

  <h3>Por Agotarse (â‰¤2 unidades)</h3>
  <ul id="listaPorAgotarse"></ul>

  <h3>Agotados</h3>
  <ul id="listaAgotados"></ul>

  <!-- LibrerÃ­a PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Script principal -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getFirestore, 
      addDoc,        // ðŸ‘ˆ para crear documentos con id automÃ¡tico
      getDocs, 
      collection, 
      deleteDoc,     // ðŸ‘ˆ para eliminar documentos por id
      doc            // ðŸ‘ˆ para referenciar documentos especÃ­ficos
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDrfX2Fszw9-M1DwzX_Sk63et9tw4ddOU",
      authDomain: "glowzzainventario.firebaseapp.com",
      projectId: "glowzzainventario",
      storageBucket: "glowzzainventario.firebasestorage.app",
      messagingSenderId: "159721581844",
      appId: "1:159721581844:web:f62cdb303258dc847b6601"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Al cargar la pÃ¡gina, leer productos desde Firebase
    document.addEventListener("DOMContentLoaded", async () => {
      const productosSnap = await getDocs(collection(db, "productos"));
      productosSnap.forEach((docSnap) => {
        const prod = docSnap.data();

        const li = document.createElement("li");
        li.textContent = `${prod.nombre} (${prod.color || ""}) - Stock: ${prod.stock} - Precio: $${prod.precio} - Fecha: ${prod.fecha}`;
        li.dataset.productoId = docSnap.id; // ðŸ‘ˆ id automÃ¡tico del documento

        document.getElementById("listaStock").appendChild(li);

        if (Number(prod.stock) === 0) {
          document.getElementById("listaAgotados").appendChild(li.cloneNode(true));
        } else if (Number(prod.stock) <= 2) {
          document.getElementById("listaPorAgotarse").appendChild(li.cloneNode(true));
        }
      });

      // Activar carga de CSV
      const input = document.getElementById("archivoExcel");
      input.addEventListener("change", function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
          header: true,
          complete: function(results) {
            subirProductos(results.data);
          }
        });
      });
    });

    async function subirProductos(productos) {
      for (const prod of productos) {
        try {
          const docRef = await addDoc(collection(db, "productos"), {
            nombre: prod.nombre,
            color: prod.color,
            precio: Number(prod.precio),
            stock: Number(prod.stock),
            fecha: prod.fecha || new Date().toISOString()
          });

          const li = document.createElement("li");
          li.textContent = `${prod.nombre} (${prod.color}) - Stock: ${prod.stock} - Precio: $${prod.precio} - Fecha: ${prod.fecha}`;
          li.dataset.productoId = docRef.id; // ðŸ‘ˆ id automÃ¡tico

          document.getElementById("listaStock").appendChild(li);

          if (Number(prod.stock) === 0) {
            alert(`âš ï¸ El producto "${prod.nombre} (${prod.color})" estÃ¡ AGOTADO`);
            document.getElementById("listaAgotados").appendChild(li.cloneNode(true));
          } else if (Number(prod.stock) <= 2) {
            alert(`âš ï¸ El producto "${prod.nombre} (${prod.color})" estÃ¡ por agotarse (quedan ${prod.stock})`);
            document.getElementById("listaPorAgotarse").appendChild(li.cloneNode(true));
          }
        } catch (err) {
          console.error("Error al subir producto:", err);
        }
      }
      alert("Carga de productos finalizada");
    }
  </script>
</body>
</html>