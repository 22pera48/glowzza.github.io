<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Stock</title>
</head>
<body>
  <h2>Control de Stock</h2>
  <button onclick="document.getElementById('archivoExcel').click()">Subir CSV</button>
  <button onclick="document.getElementById('archivoWhatsapp').click()">Subir WhatsApp</button>
  <button onclick="location.href='menu.html'">Volver al Menú Principal</button>

  <input type="file" id="archivoExcel" style="display:none" accept=".csv">
  <input type="file" id="archivoWhatsapp" style="display:none" accept=".txt">

  <h3>Listado General</h3>
  <ul id="listaStock"></ul>

  <h3>Por Agotarse (≤2 unidades)</h3>
  <ul id="listaPorAgotarse"></ul>

  <h3>Agotados</h3>
  <ul id="listaAgotados"></ul>

  <h3>Errores en carga (<span id="contadorErrores">0</span>)</h3>
  <ul id="listaErrores"></ul>

  <!-- Librería PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Script principal -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getFirestore, 
      addDoc,        
      getDocs, 
      collection, 
      updateDoc,
      deleteDoc,
      doc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDrfX2Fszw9-M1DwzX_Sk63et9tw4ddOU",
      authDomain: "glowzzainventario.firebaseapp.com",
      projectId: "glowzzainventario",
      storageBucket: "glowzzainventario.firebasestorage.app",
      messagingSenderId: "159721581844",
      appId: "1:159721581844:web:f62cdb303258dc847b6601"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function crearItem(prod, productoId, conBoton = true) {
      const li = document.createElement("li");

      if (conBoton) {
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.style.marginRight = "10px";
        btnEliminar.onclick = async () => {
          if (confirm(`¿Seguro que querés eliminar "${prod.nombre} (${prod.color})"?`)) {
            await deleteDoc(doc(db, "productos", productoId));
            li.remove();
            alert(`Producto eliminado: ${prod.nombre} (${prod.color})`);
          }
        };
        li.appendChild(btnEliminar);
      }

      const texto = document.createTextNode(
        `${prod.nombre} (${prod.color || ""}) - Stock: ${prod.stock} - Precio: $${prod.precio} - Fecha: ${prod.fecha} - Categoría: ${prod.categoria} - ID: ${productoId}`
      );
      li.appendChild(texto);

      return li;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const productosSnap = await getDocs(collection(db, "productos"));
      productosSnap.forEach((docSnap) => {
        const prod = docSnap.data();

        const liGeneral = crearItem(prod, docSnap.id, true);
        document.getElementById("listaStock").appendChild(liGeneral);

        if (Number(prod.stock) === 0) {
          const liAgotado = crearItem(prod, docSnap.id, false);
          document.getElementById("listaAgotados").appendChild(liAgotado);
        } else if (Number(prod.stock) <= 2) {
          const liPorAgotarse = crearItem(prod, docSnap.id, false);
          document.getElementById("listaPorAgotarse").appendChild(liPorAgotarse);
        }
      });

      const inputCSV = document.getElementById("archivoExcel");
      inputCSV.addEventListener("change", function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
          header: true,
          complete: function(results) {
            subirProductos(results.data);
          }
        });
      });

      const inputWhatsapp = document.getElementById("archivoWhatsapp");
      inputWhatsapp.addEventListener("change", function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          const lines = ev.target.result.split("\n");

          let contador = 1;
          const productos = [];
          const errores = [];

          lines.forEach(line => {
            line = line.replace(/^\d{1,2}\/\d{1,2}\/\d{4},\s*\d{1,2}:\d{2}\s*-\s*/, "");
            const idx = line.indexOf(":");
            if (idx !== -1) line = line.substring(idx + 1).trim();
            line = line.replace(/<Se editó.*?>/i, "").trim();

            const parts = line.split(",");
            if (parts.length >= 6) {
              productos.push({
                nombre: `[${contador}] ${parts[0].trim()}`,
                color: parts[1].trim(),
                precio: Number(parts[2]),
                stock: Number(parts[3]),
                fecha: parts[4].trim(),
                categoria: parts[5].trim()
              });
              contador++;
            } else {
              errores.push(line);
            }
          });

          subirProductos(productos);

          const listaErrores = document.getElementById("listaErrores");
          const contadorErrores = document.getElementById("contadorErrores");
          contadorErrores.textContent = errores.length; // mostrar cantidad de errores

          errores.forEach(err => {
            const li = document.createElement("li");
            li.textContent = `Error: ${err}`;
            listaErrores.appendChild(li);
          });
        };
        reader.readAsText(file);
      });
    });

    async function subirProductos(productos) {
      for (const prod of productos) {
        try {
          const q = query(
            collection(db, "productos"),
            where("nombre", "==", prod.nombre),
            where("color", "==", prod.color)
          );
          const snap = await getDocs(q);

          let productoId;
          if (!snap.empty) {
            const docSnap = snap.docs[0];
            productoId = docSnap.id;
            await updateDoc(doc(db, "productos", productoId), {
              stock: Number(prod.stock),
              precio: Number(prod.precio),
              fecha: prod.fecha || new Date().toISOString(),
              categoria: prod.categoria || ""
            });
          } else {
            const docRef = await addDoc(collection(db, "productos"), {
              nombre: prod.nombre,
              color: prod.color,
              precio: Number(prod.precio),
              stock: Number(prod.stock),
              fecha: prod.fecha || new Date().toISOString(),
              categoria: prod.categoria || ""
            });
            productoId = docRef.id;
          }

          const liGeneral = crearItem(prod, productoId, true);
          document.getElementById("listaStock").appendChild(liGeneral);

          if (Number(prod.stock) === 0) {
            const liAgotado = crearItem(prod, productoId, false);
            document.getElementById("listaAgotados").appendChild(liAgotado);
          } else if (Number(prod.stock) <= 2) {
            const liPorAgotarse = crearItem(prod, productoId, false);
            document.getElementById("listaPorAgotarse").appendChild(liPorAgotarse);
          }
        } catch (err) {
          console.error("Error al subir producto:", err);
        }
      }
      alert("Carga de productos finalizada");
    }
  </script>
</body>
</html>